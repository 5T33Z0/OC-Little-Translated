# Sound Card IRQ Patches (`SSDT-HPET`)

## Description
Sound cards of older systems (mobile Ivy Bridge for example) require High Precision Event Timer **HPET** **`PNP0103`** to provide interrupts `0` and `8`, otherwise the sound card won't work, even if `AppleALC.kext` is present and the correct layout-id is used. That's because `AppleHDA.kext` is not loaded (only `AppleHDAController.kext` is).

In most cases, almost all machines have **HPET** without any interrupts. Usually, interrupts `0` & `8` are occupied by **RTC** **`PNP0B00`** or **TIMR** **`PNP0100`** respectively. To solve this issue, we need to fix **HPET**, **RTC** and **TIMR** simultaneously.

But the issue can occur on newer platforms as well. This is due to the fact that `HPET` is a legacy device from Intel's 6th Gen platform and is only present for backward compatibility with older Windows versions. If you use 7th Gen Intel Core CPU or newer with Windows 8.1+, HPET (High Precision Event Timer) is no longer present in Device Manager (the driver is unloaded).

For macOS 10.12 and newer, if the problem occurs on the 6th Gen, `HPET` can be blocked directly to solve the problem. Check the original DSDT's HPET `_STA` method for specific settings.

## Patching Principle

- Disable **HPET**, **RTC**, **TIMR**.
- Create fake **HPE0**, **RTC0**, **TIM0**.
- Remove `IRQNoFlags (){8}` from **RTC0** and `IRQNoFlags (){0}` from **TIM0** and add them to **HPE0**.

### Patching Methods

Two methods for fixing **HPET** and **IRQs** exist:

1. **Automated method** using the python script SSDTTime (simple, for Novice Users).</br>
**Advantage**: No ACPI skills required.</br>
**Disadvantage**: Requires binary renames, so it's not as clean as using method 2, which is completely ACPI-based.
2. **Manual method** (complicated, for Advanced Users)</br>
**Advantages**: Doesn't require binary renames, is fully ACPI-compliant and can be applied to macOS only.</br>
**Disadvantage**: Requires analysis of the DSDT and adjustments of the SSDT sample.

## 1. Automated Method (using SSDTTime)

The manual patching method described below is rather complicated, because the patching process can now be automated using **SSDTTime** which can generate the following SSDTs based on analyzing your system's `DSDT`:

* ***SSDT-AWAC*** &rarr; Context-Aware AWAC and Fake RTC
* ***SSDT-EC*** &rarr; OS-aware fake EC for Desktops and Laptops
* ***SSDT-PLUG*** &rarr; Sets plugin-type to 1 on `CPU0`/`PR00`
* ***SSDT-HPET*** &rarr; Patches out IRQ Conflicts
* ***SSDT-PMC*** &rarr; Enables Native NVRAM on true 300-Series Boards

**HOW TO:**

1. Download [**SSDTTime**](https://github.com/corpnewt/SSDTTime) and run it
2. Pres "D", drag in your system's DSDT and hit "ENTER"
3. Generate all the SSDTs you need.
4. The SSDTs will be stored under `Results` inside the `SSDTTime-master` Folder along with `patches_OC.plist`.
5. Copy the generated `SSDTs` to EFI/OC/ACPI
6. Open `patches_OC.plist` and copy the included patches to your `config.plist` (to the same section, of course).
7. Save your config
8. Save. Reboot. Done. 

Audio should work now (assuming AppleALC.kext is present along with the correct layout-id for your on-board audio card).

## Troubleshooting
Some UEFI's ACPI implementations don't "understand" the way, the IRQ flags injected by `SSDT-HPET.aml`. **SSDT-HPET** generated by SSDTTime injects the IRQs this way:

```asl
...
{	
	IRQNoFlags ()
	    {0,8,11}
...
```
If you don't have sound after injecting **SSDT-HPET** and the required binary renames, change the formatting of this section to:

```asl
...
{
	IRQNoFlags ()
	    {0}
	IRQNoFlags ()
	    {8}
	IRQNoFlags ()
	    {11}
...
``` 
Save the file and reboot. Sound should work now.

**NOTE:**
If you are editing your config using [**OpenCore Auxiliary Tools**](https://github.com/ic005k/QtOpenCoreConfig/releases), OCAT it will update the list of kexts and .aml files automatically, since it monitors the EFI folder.

## 2. Manual Method
Below you will find the guide for fixing IRQ issues manually if you don't want to use SSDTTime.

- The sound card on earlier machines require **HPET** **`PNP0103`** to provide interrupt numbers `0` & `8`, otherwise the sound card would not work properly. In reality, almost all machines have **HPET** without any interrupt number provided. Usually, interrupt numbers `0` & `8` are occupied by **RTC** **`PNP0B00`**, **TIMR** **`PNP0100`** respectively
- To solve the above problem, we need to fix **HPET**, **RTC** and **TIMR** simultaneously.

## Patching principle
To fix this issue, we use ***SSDT-HPET_RTC_TIMR-fix***, which does the following:

- Disables original **HPET**, **RTC**, **TIMR** devices,
- Creates fake **HPE0**, **RTC0**, **TIM0** and finally,
- Removes `IRQNoFlags (){8}` from **RTC0** and `IRQNoFlags (){0}` from **TIM0** and adds them to **HPE0**.

## Patching method
Use ***SSDT-HPET_RTC_TIMR-fix*** to disable **HPET**, **RTC** and **TIMR**

### Disable **`HPET`**
Usually, `_STA` exists for HPET, so disabling HPET requires the use of the Preset Variable Method by changing `HPAE`/`HPTE` to `0`:

```asl
External (HPAE, IntObj) /* or External (HPTE, IntObj) */
Scope (\)
    {
    	If (_OSI ("Darwin"))
    	{
    	HPAE =0 /* or HPTE =0 */
    	}
    }
```
**NOTE**: The `HPAE`/`HPTE` variable within `_STA` may vary from machine to machine.
  
#### If `HPAE/HPTE` does not exist
On a lot of ThinkPads with Intel CPUs prior Skylake, `Device HPET` is disabled by different conditions by default, namely `WNTF` and `WXPF`, as shown below (example from a Lenovo T530): 

```asl
Device (HPET)
{
    Name (_HID, EisaId ("PNP0103") /* HPET System Timer */)  // _HID: Hardware ID
    Method (_STA, 0, NotSerialized)  // _STA: Status
    {
        If ((\WNTF && !\WXPF))
        {
            Return (0x00)
        ...
```
In this case you need to do the following:

- Rename `WNTF` to `XXXX` in `HPET`:
	```text
	Comment: HPET WNTF to XXXX
	Find: 574E5446
	Replace: 58585858
	Base: \_SB.PCI0.LPC.HPET (adjust LPC bus path accordingly)
	```
- Rename `WXPF` to `YYYY` in `HPET`:
	```text
	Comment: HPET WXPF to YYYY
	Find: 57585046
	Replace: 59595959
	Base: \_SB.PCI0.LPC.HPET (adjust LPC bus path accordingly)
	```
- Add `SSDT-HPET_RTC_TIMR_WNTF_WXPF.aml`
- Optional: Add `SSDT-IPIC` if sound doesn't work after reboot

### Disable **`RTC`**
Older machines have RTCs without `_STA`, disable RTCs by pressing the `_STA` method. e.g.:

```asl
Method (_STA, 0, NotSerialized)
{
	If (_OSI ("Darwin"))
	{
		Return (0)
	}
	Else
	{
		Return (0x0F)
	}
}
```
### Disable **`TIMR`**
(same as **RTC**)

### Disable **`IPIC`**/ **`PIC`** (optional)
Use ***SSDT-IPIC***. 

If the three-in-one patch alone does not fix audio, add ***SSDT-IPIC*** as well. It disables an existing `IPIC`/`PIC` device, adds a fake one instead and removes `IRQNoFlags{2}`. Adjust the scopes, device names and PCI paths according to your `DSDT`.

## Notes and Credits
- The names and paths of the `LPC/LPCB` bus as well as `RTC`, `TMR`, `RTC` and `IPIC` devices used in the hotpatch must match the names and paths used in the original `DSDT`.
- The IRQ and RTC fixes used here cannot be combined with other RTC fixes, such as:
  - ***SSDT-AWAC*** and ***SSDT-AWAC-ARTC***
  - ***SSDT-RTC0*** and ***SSDT-RTC0-NoFlags***
- [racka98](https://github.com/racka98) for ***SSDT-HPET_RTC_TIMR_WNTF_WXPF.dsl***
